<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: OrdersController
  
    &mdash; Documentation by YARD 0.9.9
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "OrdersController";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index (O)</a> &raquo;
    
    
    <span class="title">OrdersController</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: OrdersController
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ActionController::Base</li>
          
            <li class="next"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></li>
          
            <li class="next">OrdersController</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>app/controllers/orders_controller.rb</dd>
  </dl>
  
</div>








  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cancel-instance_method" title="#cancel (instance method)">#<strong>cancel</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create-instance_method" title="#create (instance method)">#<strong>create</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#make_purchase-instance_method" title="#make_purchase (instance method)">#<strong>make_purchase</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#purchase-instance_method" title="#purchase (instance method)">#<strong>purchase</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update-instance_method" title="#update (instance method)">#<strong>update</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ApplicationController.html#auto_update_role-instance_method" title="ApplicationController#auto_update_role (method)">#auto_update_role</a></span>, <span class='object_link'><a href="ApplicationController.html#cart_initializer-instance_method" title="ApplicationController#cart_initializer (method)">#cart_initializer</a></span></p>

  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="cancel-instance_method">
  
    #<strong>cancel</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


56
57
58
59</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/orders_controller.rb', line 56</span>

<span class='kw'>def</span> <span class='id identifier rubyid_cancel'>cancel</span>
  <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Order.html" title="Order (class)">Order</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Order.html#CANCELED_STATUS-constant" title="Order::CANCELED_STATUS (constant)">CANCELED_STATUS</a></span></span>
  <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='symbol'>:back</span><span class='comma'>,</span> <span class='label'>notice:</span> <span class='lparen'>(</span><span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Order has been successfully canceled.</span><span class='tstring_end'>&#39;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Order was not canceled.</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="create-instance_method">
  
    #<strong>create</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/orders_controller.rb', line 17</span>

<span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
  <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span>
  <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Order.html" title="Order (class)">Order</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Order.html#PENDING_STATUS-constant" title="Order::PENDING_STATUS (constant)">PENDING_STATUS</a></span></span>
  <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_perform_total_calculation'>perform_total_calculation</span>
  <span class='kw'>if</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
    <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_html'>html</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@order</span><span class='comma'>,</span> <span class='label'>notice:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Order was successfully created.</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_js'>js</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@order</span><span class='comma'>,</span> <span class='label'>notice:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Order was successfully created.</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_json'>json</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_render'>render</span> <span class='label'>json:</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbol'>:unprocessable_entity</span> <span class='rbrace'>}</span>
      <span class='comment'># For multiple browser support
</span>      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_html'>html</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='symbol'>:back</span><span class='comma'>,</span> <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="make_purchase-instance_method">
  
    #<strong>make_purchase</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/orders_controller.rb', line 61</span>

<span class='kw'>def</span> <span class='id identifier rubyid_make_purchase'>make_purchase</span>
  <span class='comment'># Used to allow multiple transation on the same order if order gets declined
</span>  <span class='comment'># lets 1000 transation tries
</span>  <span class='ivar'>@invoice_num</span> <span class='op'>=</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>1000</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="Order.html" title="Order (class)">Order</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Order.html#DECLINED_STATUS-constant" title="Order::DECLINED_STATUS (constant)">DECLINED_STATUS</a></span></span>

  <span class='comment'># create transation and request with Authorize
</span>  <span class='id identifier rubyid_transaction'>transaction</span> <span class='op'>=</span> <span class='const'>Transaction</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="top-level-namespace.html#AUTHORIZE_NET_CONFIG-constant" title="AUTHORIZE_NET_CONFIG (constant)">AUTHORIZE_NET_CONFIG</a></span></span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>api_login_id</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="top-level-namespace.html#AUTHORIZE_NET_CONFIG-constant" title="AUTHORIZE_NET_CONFIG (constant)">AUTHORIZE_NET_CONFIG</a></span></span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>api_transaction_key</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:gateway</span> <span class='op'>=&gt;</span> <span class='symbol'>:production</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_request'>request</span> <span class='op'>=</span> <span class='const'>CreateTransactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>

  <span class='comment'># set up transaction request information
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span> <span class='op'>=</span> <span class='const'>TransactionRequestType</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_amount'>amount</span> <span class='op'>=</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_total'>total</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_transactionType'>transactionType</span> <span class='op'>=</span> <span class='const'>TransactionTypeEnum</span><span class='op'>::</span><span class='const'>AuthCaptureTransaction</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_payment'>payment</span> <span class='op'>=</span> <span class='const'>PaymentType</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_payment'>payment</span><span class='period'>.</span><span class='id identifier rubyid_creditCard'>creditCard</span> <span class='op'>=</span> <span class='const'>CreditCardType</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:cc_num</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:exp_date</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:ccv</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_invoice_num'>invoice_num</span> <span class='op'>=</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="Order.html" title="Order (class)">Order</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Order.html#DECLINED_STATUS-constant" title="Order::DECLINED_STATUS (constant)">DECLINED_STATUS</a></span></span> <span class='op'>?</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='ivar'>@invoice_num</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>:</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>

  <span class='comment'># add order and line item information
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_order'>order</span> <span class='op'>=</span> <span class='const'>OrderType</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_invoice_num'>invoice_num</span><span class='comma'>,</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_event_item'>event_item</span><span class='period'>.</span><span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_lineItems'>lineItems</span> <span class='op'>=</span> <span class='const'>LineItems</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='const'>LineItemType</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span>
      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_event_item'>event_item</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='lparen'>(</span><span class='int'>16</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='comment'># itemId
</span>      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_event_item'>event_item</span><span class='period'>.</span><span class='id identifier rubyid_event'>event</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='comment'># name
</span>      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_event_item'>event_item</span><span class='period'>.</span><span class='id identifier rubyid_description'>description</span><span class='comma'>,</span> <span class='comment'># description
</span>      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_quantity'>quantity</span><span class='comma'>,</span> <span class='comment'># quantity
</span>      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_event_item'>event_item</span><span class='period'>.</span><span class='id identifier rubyid_price'>price</span><span class='comma'>,</span> <span class='comment'># unitPrice
</span>      <span class='lparen'>(</span><span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_event_item'>event_item</span><span class='period'>.</span><span class='id identifier rubyid_tax'>tax</span> <span class='op'>&gt;</span> <span class='float'>0.0</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>true</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>false</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='comment'># taxable?
</span>    <span class='rparen'>)</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='comment'># tax
</span>  <span class='kw'>if</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_event_item'>event_item</span><span class='period'>.</span><span class='id identifier rubyid_tax'>tax</span> <span class='op'>&gt;</span> <span class='float'>0.0</span>
    <span class='id identifier rubyid_tax_amount'>tax_amount</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_event_item'>event_item</span><span class='period'>.</span><span class='id identifier rubyid_price'>price</span> <span class='op'>*</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_quantity'>quantity</span><span class='rparen'>)</span> <span class='op'>*</span> <span class='lparen'>(</span><span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_event_item'>event_item</span><span class='period'>.</span><span class='id identifier rubyid_tax'>tax</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_tax'>tax</span> <span class='op'>=</span> <span class='const'>ExtendedAmountType</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_tax_amount'>tax_amount</span><span class='period'>.</span><span class='id identifier rubyid_round'>round</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>State Tax</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># add billing address to request
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_billTo'>billTo</span> <span class='op'>=</span> <span class='const'>CustomerAddressType</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_billTo'>billTo</span><span class='period'>.</span><span class='id identifier rubyid_firstName'>firstName</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_first_name'>first_name</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_billTo'>billTo</span><span class='period'>.</span><span class='id identifier rubyid_lastName'>lastName</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_last_name'>last_name</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_billTo'>billTo</span><span class='period'>.</span><span class='id identifier rubyid_zip'>zip</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:zip</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_billTo'>billTo</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_address'>address</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_billTo'>billTo</span><span class='period'>.</span><span class='id identifier rubyid_city'>city</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_city'>city</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_billTo'>billTo</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_state'>state</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_billTo'>billTo</span><span class='period'>.</span><span class='id identifier rubyid_country'>country</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_country'>country</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_billTo'>billTo</span><span class='period'>.</span><span class='id identifier rubyid_phoneNumber'>phoneNumber</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span>

  <span class='comment'># add customer info for receipt
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_customer'>customer</span> <span class='op'>=</span> <span class='const'>CustomerDataType</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_customer'>customer</span><span class='period'>.</span><span class='id identifier rubyid_email'>email</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_email'>email</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_transactionRequest'>transactionRequest</span><span class='period'>.</span><span class='id identifier rubyid_customer'>customer</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='lparen'>(</span><span class='int'>16</span><span class='rparen'>)</span> <span class='comment'># hexadecimal user.id
</span>
  <span class='comment'># perform transation with request
</span>  <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='id identifier rubyid_transaction'>transaction</span><span class='period'>.</span><span class='id identifier rubyid_create_transaction'>create_transaction</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>

  <span class='comment'># parse response
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_messages'>messages</span><span class='period'>.</span><span class='id identifier rubyid_resultCode'>resultCode</span> <span class='op'>==</span> <span class='const'>MessageTypeEnum</span><span class='op'>::</span><span class='const'>Ok</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_check_payment'>check_payment</span><span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span> <span class='comment'># check payment response code to see if anything cuased it to decline
</span>      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Order.html" title="Order (class)">Order</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Order.html#DECLINED_STATUS-constant" title="Order::DECLINED_STATUS (constant)">DECLINED_STATUS</a></span></span>
      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_transactionResponse'>transactionResponse</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Transaction Failed. \n Error Code: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_transactionResponse'>transactionResponse</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_errorCode'>errorCode</span><span class='embexpr_end'>}</span><span class='tstring_content'> \n </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_transactionResponse'>transactionResponse</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_errorText'>errorText</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Transaction Failed. \n Error Code : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_messages'>messages</span><span class='period'>.</span><span class='id identifier rubyid_messages'>messages</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span><span class='embexpr_end'>}</span><span class='tstring_content'> \n Error Message : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_messages'>messages</span><span class='period'>.</span><span class='id identifier rubyid_messages'>messages</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='symbol'>:back</span>
    <span class='kw'>else</span>
      <span class='comment'># success
</span>      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_placed_at'>placed_at</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_payment_details'>payment_details</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_to_yaml'>to_yaml</span>
      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_auth_code'>auth_code</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_transactionResponse'>transactionResponse</span><span class='period'>.</span><span class='id identifier rubyid_authCode'>authCode</span>
      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_transaction_id'>transaction_id</span> <span class='op'>=</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_transactionResponse'>transactionResponse</span><span class='period'>.</span><span class='id identifier rubyid_transId'>transId</span>
      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Order.html" title="Order (class)">Order</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Order.html#PROGRESS_STATUS-constant" title="Order::PROGRESS_STATUS (constant)">PROGRESS_STATUS</a></span></span>
      <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_send_message'>send_message</span> <span class='op'>=</span> <span class='kw'>false</span> <span class='comment'># For if refunded
</span>      <span class='kw'>if</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
        <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_decrement_max_order'>decrement_max_order</span> <span class='comment'># This needs to be after save as it will cause save issues for the last order
</span>        <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
          <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_html'>html</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@order</span><span class='comma'>,</span> <span class='label'>notice:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Order was successfully placed! Thank you for your order!</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
          <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_html'>html</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_purchase_order_path'>purchase_order_path</span><span class='lparen'>(</span><span class='ivar'>@order</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>error:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payment processed, but order was not updated. Call University Housing during regular business hours (618.453.2301).</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='comment'># failure
</span>    <span class='kw'>unless</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_transactionResponse'>transactionResponse</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Transaction Failed. \n Error Code: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_transactionResponse'>transactionResponse</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_errorCode'>errorCode</span><span class='embexpr_end'>}</span><span class='tstring_content'> \n </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_transactionResponse'>transactionResponse</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_errorText'>errorText</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Transaction Failed. \n Error Code : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_messages'>messages</span><span class='period'>.</span><span class='id identifier rubyid_messages'>messages</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span><span class='embexpr_end'>}</span><span class='tstring_content'> \n Error Message : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_messages'>messages</span><span class='period'>.</span><span class='id identifier rubyid_messages'>messages</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='symbol'>:back</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="purchase-instance_method">
  
    #<strong>purchase</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


48
49
50
51
52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/orders_controller.rb', line 48</span>

<span class='kw'>def</span> <span class='id identifier rubyid_purchase'>purchase</span>
  <span class='comment'># Just in case!!!!
</span>  <span class='kw'>if</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_event_item'>event_item</span><span class='period'>.</span><span class='id identifier rubyid_max_event'>max_event</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Event is sold out!!!</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='symbol'>:back</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update-instance_method">
  
    #<strong>update</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


35
36
37
38
39
40
41
42
43
44
45
46</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/orders_controller.rb', line 35</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update'>update</span>
  <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='id identifier rubyid_order_params'>order_params</span><span class='rparen'>)</span>
  <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_perform_total_calculation'>perform_total_calculation</span>
  <span class='kw'>if</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
    <span class='id identifier rubyid_respond_with'>respond_with</span> <span class='ivar'>@order</span><span class='comma'>,</span> <span class='label'>location:</span> <span class='tlambda'>-&gt;</span> <span class='tlambeg'>{</span> <span class='ivar'>@order</span> <span class='rbrace'>}</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_json'>json</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_render'>render</span> <span class='label'>json:</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbol'>:unprocessable_entity</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_html'>html</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='symbol'>:back</span><span class='comma'>,</span> <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@order</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Mon Jan  1 15:33:28 2018 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.9 (ruby-2.4.1).
</div>

    </div>
  </body>
</html>